<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ü¶û‚ö™ White Lobster Scoreboard</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    font-family: 'Segoe UI', system-ui, sans-serif;
    background: #0a0e1a;
    color: #e0e0e0;
    min-height: 100vh;
  }
  .header {
    text-align: center;
    padding: 20px 20px 24px;
    border-bottom: 1px solid #1a2040;
    background: #0a0e1a;
  }
  .header h1 { font-size: 24px; color: #fff; }
  .header .sub { font-size: 12px; color: #f08c8c; letter-spacing: 1px; text-transform: uppercase; margin-top: 4px; }
  .legend {
    display: flex; gap: 16px; justify-content: center;
    margin-top: 12px; font-size: 12px;
  }
  .legend span { display: flex; align-items: center; gap: 4px; }
  .legend .dot { width: 12px; height: 12px; border-radius: 3px; display: inline-block; }
  .mode-toggle {
    display: flex; gap: 8px; justify-content: center; margin-top: 14px;
  }
  .mode-btn {
    padding: 6px 20px; border-radius: 20px; border: 2px solid #1a2040;
    background: #0d1220; color: #888; cursor: pointer; font-size: 13px;
    font-weight: 600; transition: all 0.15s;
  }
  .mode-btn:hover { border-color: #2a3050; color: #ccc; }
  .mode-btn.active-gpu { border-color: #4a4; color: #6d6; background: rgba(68,170,68,0.1); }
  .mode-btn.active-cpu { border-color: #48f; color: #6af; background: rgba(68,136,255,0.1); }
  .rating-legend {
    display: flex; gap: 20px; justify-content: center;
    margin-top: 8px; font-size: 11px; color: #666;
  }

  /* Table */
  .table-wrap {
    padding: 0 20px;
  }
  table {
    border-collapse: separate;
    border-spacing: 0;
    width: 100%;
    min-width: 900px;
  }
  th, td {
    border: 1px solid #141830;
    padding: 0;
    text-align: center;
    font-size: 12px;
  }

  /* Sticky header row */
  thead th {
    background: #0d1220;
    padding: 10px 6px;
    position: sticky;
    top: 0;
    z-index: 10;
  }
  th.model-col { min-width: 160px; text-align: left; padding-left: 12px; }
  th.ctx-col { min-width: 50px; color: #8a8aaa; font-size: 11px; }
  td.ctx-cell {
    font-size: 11px; color: #99f; padding: 8px 6px; white-space: nowrap;
  }
  th.chat-col { min-width: 36px; color: #8a8aaa; font-size: 11px; }
  td.chat-cell { font-size: 13px; padding: 8px 4px; }
  th.summary-col { min-width: 200px; text-align: left; padding-left: 8px; color: #8a8aaa; font-size: 11px; }
  td.summary-cell {
    font-size: 11px; color: #888; padding: 8px; text-align: left;
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 280px;
  }
  th.step-col {
    writing-mode: vertical-lr;
    text-orientation: mixed;
    transform: rotate(180deg);
    padding: 10px 4px;
    font-size: 11px;
    min-width: 40px;
    max-width: 44px;
    white-space: nowrap;
    color: #8aa;
    transition: background 0.1s, color 0.1s;
  }
  th.step-col.col-highlight {
    background: #141e30;
    color: #bdd;
  }
  th.total-col { min-width: 60px; color: #f0c040; }
  th.rank-col { min-width: 44px; color: #f0c040; }

  /* Tier row backgrounds */
  tr.tier-impossible td { background: rgba(212, 108, 108, 0.04); }
  tr.tier-hard td { background: rgba(212, 196, 108, 0.04); }
  tr.tier-medium td { background: rgba(108, 212, 160, 0.04); }

  /* Row highlight on hover */
  tr.row-highlight td { background: rgba(108, 180, 238, 0.08) !important; }
  tr.row-highlight td.model-cell { background: rgba(108, 180, 238, 0.12) !important; }

  /* Column highlight */
  td.col-highlight { box-shadow: inset 0 0 0 1px rgba(108, 180, 238, 0.2); }

  /* Model rows - tier left border */
  tr.tier-impossible td.model-cell { border-left: 3px solid #d46c6c; }
  tr.tier-hard td.model-cell { border-left: 3px solid #d4c46c; }
  tr.tier-medium td.model-cell { border-left: 3px solid #6cd4a0; }

  td.model-cell {
    text-align: left;
    padding: 8px 12px;
    font-weight: 500;
    white-space: nowrap;
  }
  .model-name { color: #ccc; }
  .model-params { color: #99f; font-size: 10px; margin-left: 6px; }

  td.total-cell {
    font-weight: 700;
    font-size: 14px;
    padding: 8px;
  }
  td.rank-cell {
    font-weight: 700;
    font-size: 14px;
    padding: 8px;
  }

  /* Score cells */
  td.score-cell {
    cursor: pointer;
    width: 44px;
    height: 40px;
    transition: filter 0.1s;
    position: relative;
  }
  td.score-cell:hover { filter: brightness(1.4); }
  td.score-cell.s-none { color: #333; }
  td.score-cell.s-0 { background: #3a1a1a !important; color: #d46c6c; }
  td.score-cell.s-1 { background: #3a3a1a !important; color: #d4c46c; }
  td.score-cell.s-2 { background: #1a3a2a !important; color: #6cd4a0; }
  td.score-cell .val { font-size: 14px; font-weight: 600; line-height: 40px; }

  /* Totals coloring */
  .total-dead { color: #d46c6c; }
  .total-alive { color: #d4a06c; }
  .total-promise { color: #d4c46c; }
  .total-good { color: #6cd4a0; }
  .total-genius { color: #6cb4ee; }

  /* Rank medals */
  .rank-1 { color: #ffd700; }
  .rank-2 { color: #c0c0c0; }
  .rank-3 { color: #cd7f32; }

  /* Actions */
  .actions {
    display: flex; justify-content: center; gap: 12px;
    margin: 16px 0 30px;
  }
  .btn {
    padding: 6px 16px; border-radius: 6px; border: 1px solid #1a2040;
    background: #0d1220; color: #888; cursor: pointer; font-size: 12px;
  }
  .btn:hover { background: #141830; color: #ccc; }
  .btn-danger { border-color: #3a1a1a; }
  .btn-danger:hover { background: #3a1a1a; color: #d46c6c; }

  /* Tooltip */
  .tooltip {
    display: none; position: fixed;
    background: #1a1e30; border: 1px solid #2a3050; border-radius: 8px;
    padding: 12px; font-size: 12px; z-index: 100; max-width: 260px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.5);
  }
  .tooltip.show { display: block; }
  .tooltip .tt-title { color: #6cb4ee; font-weight: 600; margin-bottom: 6px; }
  .tooltip .tt-step { color: #888; margin-bottom: 8px; }
  .tooltip textarea {
    width: 100%; height: 50px; background: #0d1220; border: 1px solid #1a2040;
    border-radius: 4px; color: #ccc; font-size: 11px; padding: 6px;
    resize: vertical; font-family: inherit;
  }
  .tooltip .tt-btns { display: flex; gap: 4px; margin-top: 6px; }
  .tooltip .tt-btn {
    flex: 1; padding: 4px; text-align: center; border-radius: 4px;
    cursor: pointer; font-size: 11px; font-weight: 600;
  }
  .tt-btn-0 { background: #3a1a1a; color: #d46c6c; }
  .tt-btn-1 { background: #3a3a1a; color: #d4c46c; }
  .tt-btn-2 { background: #1a3a2a; color: #6cd4a0; }
  .tt-btn-x { background: #1a1a2a; color: #888; }
  .tt-btn:hover { filter: brightness(1.3); }
</style>
</head>
<body>

<div class="header">
  <h1>ü¶û‚ö™ White Lobster Scoreboard</h1>
  <div class="sub">10-Step Progressive Exam</div>
  <div class="legend">
    <span><div class="dot" style="background:#d46c6c"></div> üíÄ Impossible (&lt;500M)</span>
    <span><div class="dot" style="background:#d4c46c"></div> üî• Hard (500M-2B)</span>
    <span><div class="dot" style="background:#6cd4a0"></div> ‚ö° Medium (2B-4B)</span>
  </div>
  <div class="mode-toggle">
    <button class="mode-btn" id="btnGpu" onclick="switchMode('gpu')">üü¢ GPU</button>
    <button class="mode-btn" id="btnCpu" onclick="switchMode('cpu')">üîµ CPU</button>
  </div>
  <div class="rating-legend">
    <span>0 = fail</span>
    <span>1 = partial</span>
    <span>2 = pass</span>
    <span>click cell to score</span>
  </div>
</div>

<div class="table-wrap">
  <table id="scoreboard"></table>
</div>

<div class="actions">
  <button class="btn" onclick="sortByRank()">Sort by Rank</button>
  <button class="btn" onclick="sortBySize()">Sort by Size</button>
  <button class="btn btn-danger" onclick="resetAll()">Reset All</button>
</div>

<div class="tooltip" id="tooltip">
  <div class="tt-title" id="ttTitle"></div>
  <div class="tt-step" id="ttStep"></div>
  <div class="tt-btns">
    <div class="tt-btn tt-btn-0" onclick="setScore(0)">0</div>
    <div class="tt-btn tt-btn-1" onclick="setScore(1)">1</div>
    <div class="tt-btn tt-btn-2" onclick="setScore(2)">2</div>
    <div class="tt-btn tt-btn-x" onclick="clearScore()">‚úï</div>
  </div>
  <textarea id="ttNotes" placeholder="Notes..." onchange="saveNotes()"></textarea>
</div>

<script>
let DATA = null;
let currentModel = null;
let currentStep = null;
let sortMode = 'size';
let hoverRow = -1;
let hoverCol = -1;
let currentMode = 'gpu';

async function load() {
  const r = await fetch('/api/data?mode=' + currentMode);
  DATA = await r.json();
  if (!DATA.notes) DATA.notes = {};
  updateModeButtons();
  render();
  setupHover();
}

function switchMode(mode) {
  currentMode = mode;
  load();
}

function updateModeButtons() {
  document.getElementById('btnGpu').className = 'mode-btn' + (currentMode === 'gpu' ? ' active-gpu' : '');
  document.getElementById('btnCpu').className = 'mode-btn' + (currentMode === 'cpu' ? ' active-cpu' : '');
}

function getTotal(model) {
  const s = DATA.scores[model] || {};
  let t = 0;
  for (let i = 0; i < DATA.steps.length; i++) {
    if (s[i] != null) t += s[i];
  }
  return t;
}

function getRanks() {
  const totals = DATA.models.map(m => ({ name: m.name, total: getTotal(m.name) }));
  totals.sort((a, b) => b.total - a.total);
  const ranks = {};
  let rank = 1;
  for (let i = 0; i < totals.length; i++) {
    if (i > 0 && totals[i].total < totals[i-1].total) rank = i + 1;
    ranks[totals[i].name] = totals[i].total > 0 ? rank : '-';
  }
  return ranks;
}

function getModels() {
  let models = [...DATA.models];
  if (sortMode === 'rank') {
    models.sort((a, b) => getTotal(b.name) - getTotal(a.name));
  }
  return models;
}

function totalClass(t) {
  if (t <= 4) return 'total-dead';
  if (t <= 8) return 'total-alive';
  if (t <= 12) return 'total-promise';
  if (t <= 16) return 'total-good';
  return 'total-genius';
}

function render() {
  const models = getModels();
  const ranks = getRanks();
  let html = '<thead><tr>';
  html += '<th class="rank-col">#</th>';
  html += '<th class="model-col">Model</th>';
  html += '<th class="ctx-col">Ctx</th>';
  html += '<th class="chat-col">üí¨</th>';
  html += '<th class="summary-col">Summary</th>';
  for (let i = 0; i < DATA.steps.length; i++) {
    html += `<th class="step-col" data-col="${i}">S${i+1}: ${DATA.steps[i]}</th>`;
  }
  html += '<th class="total-col">Total</th>';
  html += '</tr></thead><tbody>';

  for (let ri = 0; ri < models.length; ri++) {
    const m = models[ri];
    const scores = DATA.scores[m.name] || {};
    const total = getTotal(m.name);
    const rank = ranks[m.name];
    const rankClass = rank <= 3 && rank !== '-' ? `rank-${rank}` : '';

    html += `<tr class="tier-${m.tier}" data-row="${ri}">`;
    html += `<td class="rank-cell ${rankClass}">${rank}</td>`;
    html += `<td class="model-cell"><span class="model-name">${m.name}</span><span class="model-params">${m.params}</span></td>`;
    html += `<td class="ctx-cell">${m.ctx || '?'}</td>`;
    html += `<td class="chat-cell">${m.chat ? '‚úÖ' : '‚ùå'}</td>`;
    html += `<td class="summary-cell" title="${(m.summary||'').replace(/"/g,'&quot;')}">${m.summary || ''}</td>`;

    for (let i = 0; i < DATA.steps.length; i++) {
      const s = scores[i];
      const cls = s != null ? `s-${s}` : 's-none';
      const val = s != null ? s : '¬∑';
      const noteKey = `${m.name}__${i}`;
      const hasNote = DATA.notes[noteKey] ? ' *' : '';
      html += `<td class="score-cell ${cls}" data-model="${m.name}" data-step="${i}" data-row="${ri}" data-col="${i}" onclick="openTooltip(event, '${m.name}', ${i})"><span class="val">${val}${hasNote}</span></td>`;
    }

    html += `<td class="total-cell ${totalClass(total)}">${total}/20</td>`;
    html += '</tr>';
  }

  html += '</tbody>';
  document.getElementById('scoreboard').innerHTML = html;
  setupHover();
}

function setupHover() {
  const table = document.getElementById('scoreboard');

  table.addEventListener('mouseover', (e) => {
    const cell = e.target.closest('td.score-cell');
    if (!cell) {
      clearHighlight();
      return;
    }
    const row = parseInt(cell.dataset.row);
    const col = parseInt(cell.dataset.col);
    if (row === hoverRow && col === hoverCol) return;
    hoverRow = row;
    hoverCol = col;
    applyHighlight(row, col);
  });

  table.addEventListener('mouseleave', clearHighlight);
}

function applyHighlight(row, col) {
  // Clear previous
  document.querySelectorAll('.row-highlight').forEach(el => el.classList.remove('row-highlight'));
  document.querySelectorAll('.col-highlight').forEach(el => el.classList.remove('col-highlight'));

  // Highlight row
  const tr = document.querySelector(`tr[data-row="${row}"]`);
  if (tr) tr.classList.add('row-highlight');

  // Highlight column header
  const th = document.querySelector(`th[data-col="${col}"]`);
  if (th) th.classList.add('col-highlight');

  // Highlight all cells in this column
  document.querySelectorAll(`td[data-col="${col}"]`).forEach(td => {
    td.classList.add('col-highlight');
  });
}

function clearHighlight() {
  hoverRow = -1;
  hoverCol = -1;
  document.querySelectorAll('.row-highlight').forEach(el => el.classList.remove('row-highlight'));
  document.querySelectorAll('.col-highlight').forEach(el => el.classList.remove('col-highlight'));
}

function openTooltip(e, model, step) {
  currentModel = model;
  currentStep = step;
  const tt = document.getElementById('tooltip');
  document.getElementById('ttTitle').textContent = model;
  document.getElementById('ttStep').textContent = `Step ${step+1}: ${DATA.steps[step]}`;
  const noteKey = `${model}__${step}`;
  document.getElementById('ttNotes').value = DATA.notes[noteKey] || '';

  const rect = e.target.getBoundingClientRect();
  let left = rect.right + 8;
  let top = rect.top;
  if (left + 270 > window.innerWidth) left = rect.left - 270;
  if (top + 200 > window.innerHeight) top = window.innerHeight - 210;
  tt.style.left = left + 'px';
  tt.style.top = top + 'px';
  tt.classList.add('show');
  e.stopPropagation();
}

document.addEventListener('click', (e) => {
  if (!e.target.closest('.tooltip') && !e.target.closest('.score-cell')) {
    document.getElementById('tooltip').classList.remove('show');
  }
});

async function setScore(score) {
  await fetch('/api/score', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ model: currentModel, step: currentStep, score, mode: currentMode })
  });
  if (!DATA.scores[currentModel]) DATA.scores[currentModel] = {};
  DATA.scores[currentModel][currentStep] = score;
  render();
}

async function clearScore() {
  await fetch('/api/score', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ model: currentModel, step: currentStep, score: 0, mode: currentMode })
  });
  const data = await (await fetch('/api/data?mode=' + currentMode)).json();
  if (data.scores[currentModel]) delete data.scores[currentModel][currentStep];
  DATA = data;
  if (!DATA.notes) DATA.notes = {};
  document.getElementById('tooltip').classList.remove('show');
  render();
}

async function saveNotes() {
  const notes = document.getElementById('ttNotes').value;
  await fetch('/api/notes', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ model: currentModel, step: currentStep, notes, mode: currentMode })
  });
  DATA.notes[`${currentModel}__${currentStep}`] = notes;
  render();
}

function sortByRank() { sortMode = 'rank'; render(); }
function sortBySize() { sortMode = 'size'; render(); }

async function resetAll() {
  if (!confirm('Reset ALL scores? This cannot be undone.')) return;
  await fetch('/api/reset', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ mode: currentMode }) });
  DATA.scores = {};
  DATA.notes = {};
  render();
}

load();
</script>
</body>
</html>
